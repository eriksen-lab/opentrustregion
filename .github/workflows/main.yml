name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-test-repo:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            compiler: gnu
            runs-on: ubuntu-latest
            python-version: "3.10"
            cmargs: ""
          - os: linux
            compiler: intel
            runs-on: ubuntu-latest
            python-version: "3.10"
            cmargs: ""
          - os: macos-silicon
            compiler: clang
            runs-on: macos-latest
            python-version: "3.10"
            cmargs: ""
          - os: macos-intel
            compiler: clang
            runs-on: macos-13
            python-version: "3.10"
            cmargs: ""

    name: "Repo • 🐍 ${{ matrix.python-version }} • OS ${{ matrix.os }} • Compiler ${{ matrix.compiler }}"
    runs-on: ${{ matrix.runs-on }}
    defaults:
      run:
        shell: bash -l {0}

    steps:
    - name: Checkout OpenTrustRegion
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.x

    - name: Install GNU compilers
      if: ${{ matrix.compiler == 'gnu' && matrix.os == 'linux' }}
      run: |
        apt update
        apt install -y gcc gfortran

    - name: Add Intel oneAPI repository
      if: ${{ matrix.compiler == 'intel' }}
      run: |
        wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
        echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
        apt update

    - name: Install Intel oneAPI Fortran Compiler
      if: ${{ matrix.compiler == 'intel' }}
      run: apt install -y intel-oneapi-compiler-fortran

    - name: Install Intel oneAPI MKL
      if: ${{ matrix.compiler == 'intel' }}
      run: apt install -y intel-oneapi-mkl

    - name: Setup Intel oneAPI environment
      if: ${{ matrix.compiler == 'intel' }}
      run: |
        source /opt/intel/oneapi/setvars.sh
        printenv >> $GITHUB_ENV

    - name: Install OpenBLAS on MacOS
      if: ${{ contains(matrix.os, 'macos') }}
      run: |
        brew install openblas
        echo "PKG_CONFIG_PATH=/usr/local/opt/openblas/lib/pkgconfig" >> $GITHUB_ENV
        echo "LDFLAGS=-L/opt/homebrew/opt/openblas/lib" >> $GITHUB_ENV
        echo "CPPFLAGS=-I/opt/homebrew/opt/openblas/include" >> $GITHUB_ENV

    - name: Install OpenBLAS on Linux
      if: ${{ matrix.compiler == 'gnu' && matrix.os == 'linux' }}
      run: |
        apt install -y libopenblas-dev

    - name: Build & Install OpenTrustRegion
      run: pip3 install ${{github.workspace}}

    - name: Testing OpenTrustRegion
      run: python3 -m pyopentrustregion.testsuite
